name: Enhanced CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Code Quality Gates
  code-quality:
    name: Code Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: code-quality

    - name: Check formatting
      run: cargo fmt --all -- --check

    - name: Run clippy
      run: cargo clippy --all-targets --all-features -- -D warnings

    - name: Run cargo audit
      run: cargo audit

    - name: Run cargo deny
      run: cargo deny check

    # Test Suite Execution
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable, beta]
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview

    - name: Install cargo-llvm-cov
      run: cargo install cargo-llvm-cov

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Run tests with coverage
      run: cargo llvm-cov --all-features --workspace --lcov --output-path coverage.lcov

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: coverage.lcov
        flags: unittests
        name: codecov-${{ matrix.os }}

    - name: Run specific integration tests
      run: cargo test --test integration --verbose

    # Performance Benchmarking
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: benchmark

    - name: Install cargo-criterion
      run: cargo install cargo-criterion

    - name: Run benchmarks
      run: cargo criterion --message-format=json > criterion.json

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: criterion.json

    - name: Performance regression check
      run: |
        # Install criterion parser
        pip install criterion-parser
        # Parse and check for regressions
        python scripts/check_benchmarks.py criterion.json

    # Security Scanning and Analysis
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install security tools
      run: |
        cargo install cargo-audit cargo-deny cargo-sbom

    - name: Run comprehensive security audit
      run: |
        cargo audit --json > audit.json
        cargo deny check --format json > deny.json

    - name: Generate SBOM
      run: cargo sbom --output-format json --output-file sbom.json

    - name: Run Trivy filesystem scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Upload security artifacts
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          audit.json
          deny.json
          sbom.json

    # Cross-Platform Build Matrix
  build:
    name: Build Application
    needs: [code-quality, test, security-scan]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            args: --release
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            args: --release
          - os: macos-latest
            target: x86_64-apple-darwin
            args: --release
          - os: macos-latest
            target: aarch64-apple-darwin
            args: --release

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Install platform-specific tools (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # Install Windows SDK and tools if needed
        echo "Windows build tools configured"

    - name: Install platform-specific tools (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # Install Xcode command line tools
        xcode-select --install

    - name: Build application
      run: cargo build ${{ matrix.args }} --target ${{ matrix.target }}

    - name: Generate build info
      run: |
        echo "BUILD_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')" >> $GITHUB_ENV
        echo "BUILD_TARGET=${{ matrix.target }}" >> $GITHUB_ENV
        echo "BUILD_OS=${{ matrix.os }}" >> $GITHUB_ENV
        echo "BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_ENV

    - name: Create build manifest
      run: |
        cat > build-manifest.json << EOF
        {
          "version": "${{ env.BUILD_VERSION }}",
          "target": "${{ env.BUILD_TARGET }}",
          "os": "${{ env.BUILD_OS }}",
          "build_time": "${{ env.BUILD_TIME }}",
          "git_commit": "${{ github.sha }}",
          "git_ref": "${{ github.ref_name }}"
        }
        EOF

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.target }}
        path: |
          target/${{ matrix.target }}/${{ matrix.args == '--release' && 'release' || 'debug' }}/herding-cats-rust*
          build-manifest.json

    # Platform-Specific Packaging
  package:
    name: Package Application
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            package_type: deb
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            package_type: AppImage
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            package_type: msi
          - os: macos-latest
            target: x86_64-apple-darwin
            package_type: dmg
          - os: macos-latest
            target: aarch64-apple-darwin
            package_type: dmg

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-${{ matrix.target }}
        path: build/

    - name: Setup packaging tools (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential rpm

    - name: Setup packaging tools (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # Install create-dmg and other macOS packaging tools
        brew install create-dmg

    - name: Create package
      run: |
        chmod +x scripts/create-package.sh
        ./scripts/create-package.sh ${{ matrix.package_type }} ${{ matrix.target }}

    - name: Upload packages
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ matrix.target }}
        path: packages/*

    # Docker Container Build
  docker-build:
    name: Docker Container
    needs: [code-quality, test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: herding-cats-rust
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    - name: Scan Docker image
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'image'
        scan-ref: 'herding-cats-rust:latest'
        format: 'sarif'
        output: 'docker-scan-results.sarif'

    - name: Upload Docker scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'docker-scan-results.sarif'

    # Release Management
  release:
    name: Create Release
    needs: [package, docker-build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Prepare release assets
      run: |
        mkdir -p release
        cp -r packages-*/* release/
        cp build-*/*/build-manifest.json release/
        
        # Create checksums
        cd release
        sha256sum * > checksums.txt
        cd ..

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## Changes in this release
          
          See [CHANGELOG.md](CHANGELOG.md) for detailed changes.
          
          ## Build Information
          - Version: ${{ github.ref_name }}
          - Commit: ${{ github.sha }}
          - Build Time: $(date -u)
          
          ## Downloads
          
          All platform-specific packages are available for download.
          
          Verify package integrity using the included checksums.txt file.
        files: |
          release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Notification and Reporting
  notify:
    name: Notify Results
    needs: [code-quality, test, benchmark, security-scan, build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify success
      if: needs.code-quality.result == 'success' && needs.test.result == 'success' && needs.security-scan.result == 'success' && needs.build.result == 'success'
      run: |
        echo "✅ All CI checks passed successfully!"
        # Add webhook notification here if needed

    - name: Notify failure
      if: needs.code-quality.result == 'failure' || needs.test.result == 'failure' || needs.security-scan.result == 'failure' || needs.build.result == 'failure'
      run: |
        echo "❌ Some CI checks failed!"
        echo "Failed jobs: ${{ toJson(needs) }}"
        # Add webhook notification here if needed